<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script>
    var EventNextIterationCode = String.fromCharCode({{.EventNextIterationCode}});
    var EventOnDataCode = String.fromCharCode({{.EventOnDataCode}});
    var EventLogRemovedCode = String.fromCharCode({{.EventLogRemovedCode}});
    window.addEventListener("load", function (evt) {
      var output = document.getElementById("output");
      var input = document.getElementById("input");
      var readerWs;
      var currentSendElem = null;
      var currentResponseElem = null;
      var print = function (message) {
        var d = document.createElement("div");
        d.innerHTML = message;
        output.appendChild(d);
        currentResponseElem = null;
        currentSendElem = null;
      };
      var displaySend = function (message) {
        if (!currentSendElem) {
          currentSendElem = document.createElement("div");
          output.appendChild(currentSendElem);
        }
        currentSendElem.innerHTML = message;
      };
      var appendResponse = function (message) {
        if (!currentResponseElem) {
          currentResponseElem = document.createElement("div");
          currentResponseElem.innerHTML = "RESPONSE: ";
          output.appendChild(currentResponseElem);
        }
        currentResponseElem.innerHTML += message;
      };
      var clearResponse = function () {
        displaySend("")
        appendResponse("")
        currentResponseElem.innerHTML = "RESPONSE: ===new iteration===<br />";
      }
      var logRemoved = function () {
        if (!currentResponseElem) {
          currentResponseElem = document.createElement("div");
          currentResponseElem.innerHTML = "RESPONSE: ";
          output.appendChild(currentResponseElem);
        }
        currentResponseElem.innerHTML += "<br />===log removed===<br />";
      };
      document.getElementById("open").onclick = function (evt) {
        if (readerWs) {
          return false;
        }
        readerWs = new WebSocket("{{.WsBaseUrl}}");
        readerWs.binaryType = 'blob'
        readerWs.onopen = function (evt) {
          print("OPEN");
          readerWs.send("password");
        }
        readerWs.onclose = function (evt) {
          print("CLOSE");
          readerWs = null;
        }
        readerWs.onmessage = function (evt) {
          if (evt.data instanceof Blob) {
            evt.reader = new FileReader();
            evt.reader.onload = function () {
              if (evt.reader.result && evt.reader.result.length > 0) {
                console.log(evt.reader.result);
                switch (evt.reader.result[0]) {
                  case EventOnDataCode:
                    appendResponse(evt.reader.result.slice(2));
                    break;
                  case EventNextIterationCode:
                    clearResponse();
                    break;
                  case EventLogRemovedCode:
                    logRemoved();
                    break;
                }
              }
            };
            evt.reader.readAsText(evt.data);
          } else {
            print("RESPONSE: " + evt.data);
          }
        }
        readerWs.onerror = function (evt) {
          print("ERROR: " + evt.data);
        }
        return false;
      };
      document.getElementById("send").onclick = function (evt) {
        if (!readerWs) {
          return false;
        }
        displaySend("SEND: " + input.value);
        readerWs.send("\1" + input.value);
        return false;
      };
      document.getElementById("clear").onclick = function (evt) {
        if (!readerWs) {
          return false;
        }
        readerWs.send("\2");
        return false;
      };
      document.getElementById("removelog").onclick = function (evt) {
        if (!readerWs) {
          return false;
        }
        readerWs.send("\3");
        return false;
      };
      document.getElementById("close").onclick = function (evt) {
        if (!readerWs) {
          return false;
        }
        readerWs.close();
        return false;
      };
    });
  </script>
</head>

<body>
  <table>
    <tr>
      <td valign="top" width="50%">
        <p>Click "Open" to create a connection to the server,
          "Send" to send a message to the server and "Close" to close the connection.
          You can change the message and send multiple times.
          <p>
            <form>
              <button id="open">Open</button>
              <button id="close">Close</button>
              <p><input id="input" type="text" value="Hello world!">
                <button id="send">Send</button>
                <button id="clear">Clear</button>
                <button id="removelog">Remove Log</button>
            </form>
      </td>
      <td valign="top" width="50%">
        <div id="output"></div>
      </td>
    </tr>
  </table>
</body>

</html>